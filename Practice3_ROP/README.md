# Práctica 3: ROP

## OBJETIVO

Esta práctica consiste en crear una cadena ROP que sea capaz de activar el permiso de ejecución de una región de memoria para después transferir el control a un shellcode inyectado allí. El shellcode debe ser el de tu ejercicio anterior, para volcar el fichero /etc/passwd.

La cadena ROP debe ejecutar la llamada al sistema mprotect(2) para activar el permiso de ejecución en la página de memoria que contiene el shellcode que queremos terminar ejecutando. Lee la página de manual de esta llamada al sistema: la dirección de memoria que se le pasa debe estar alineada a tamaño de página. Puedes encontrar el valor de los flags que te interesan (PROT_EXEC, PROT_WRITE, PROT_READ) en los ficheros de cabecera que están en los directorios de /usr/include.

La cadena ROP debe estar construida para ejecutar correctamente en la máquina virtual que puedes descargar de aquí:

http://gsyc.urjc.es/~esoriano/smalldebian.ova

Puedes importar la máquina virtual en Virtual Box. Tiene creado un usuario llamado mal (la contraseña es el nombre de usuario, mal). La prueba debe ejecutar correctamente en esa máquina virtual, en la cuenta mal. Puedes intercambiar ficheros usando el comando scp desde dentro de la máquina virtual, la IP de tu máquina será 10.0.2.2.

La cadena ROP tiene que estar hecha para la versión de la libc de ese sistema:

$ sha1sum  libc.so.6
56f0f854b7ee22aa0d25a7a13a5a6b3dee0406a2  libc.so.6

## PROGRAMA


Vamos a probar la cadena ROP pivotando la pila mediante con rop.c

El programa se debe compilar así:

gcc rop.c -o rop

Una vez completado (con la cadena ROP correcta), al ejecutarlo

./rop

debemos ver que se ejecuta el shellcode (esto es, que se muestra por la salida el fichero /etc/passwd).

## DIRECCIONES

Lo primero que tienes que encontrar son dos direcciones:

    - La dirección base de la libc del sistema de la máquina virtual

    - La dirección de la variable global que tiene el shellcode

Necesitarás estas dos direcciones para crear la cadena ROP.

## BÚSQUEDA DE GADGETS

Tienes que buscar los gadgets de la libc que se usa en la máquina virtual.

Sólo contemplaremos gadgets ROP que terminen en un return.

Para ello, debes usar estos comandos de radare2 (está instalado en la máquina virtual):

  aaa  
  e asm.syntax=att  
  e search.in=bin.sections.exec  
  /R ret > gadgets.txt  
  quit  

El segundo comando se asegura de que los gadgets estén en una sección que tenga permisos de ejecución (si buscas gadgets en otras secciones no ejecutables de la libc, no podrás usarlos después y tu programa fallará).

En el fichero gadgets.txt ya tienes todos los gadgets disponibles. Puedes buscar dentro del fichero.

## ENTREGA

Se deben entregar tres ficheros:

- **rop.c**: fichero fuente C  con la cadena ROP y el shellcode, listo para compilar como se indica más arriba.

- **rop**: binario generado, listo para ejecutar dentro de la máquina virtual.

- **memoria.txt**: fichero de texto plano con una breve descripción de los pasos que se han realizado para crear la cadena ROP, gadgets elegidos (con su dirección),  qué hace cada parte de la misma, cómo se ha obtenido la base de la libc, etc.
